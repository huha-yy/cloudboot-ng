#
# CloudBoot NG - Kickstart Configuration
# Generated for: {{.Machine.Hostname}} ({{.Machine.MacAddress}})
# OS: {{.Profile.Distro}} {{.Profile.Version}}
# Profile ID: {{.Profile.ID}}
#

# System language
lang en_US.UTF-8

# Keyboard layouts
keyboard us

# System timezone
timezone {{.Profile.Config.Timezone}} --utc

# Root password (encrypted)
{{if .Profile.Config.RootPasswordHash}}
rootpw --iscrypted {{.Profile.Config.RootPasswordHash}}
{{else}}
rootpw --plaintext cloudboot123
{{end}}

# System authorization information
auth --enableshadow --passalgo=sha512

# Use network installation
url --url={{.Profile.Config.RepoURL}}

# Firewall configuration
firewall --disabled

# SELinux configuration
selinux --disabled

# Do not configure the X Window System
skipx

# System bootloader configuration
bootloader --location=mbr --append="console=tty0 console=ttyS0,115200n8"

# Clear the Master Boot Record
zerombr

# Partition clearing information
clearpart --all --initlabel

# Disk partitioning information
{{if .Profile.Config.Partitions}}
{{range .Profile.Config.Partitions}}
{{if eq .MountPoint "/"}}
part {{.MountPoint}} --fstype={{.FileSystem}} --size={{.SizeMB}} --grow
{{else if eq .MountPoint "swap"}}
part swap --fstype=swap --size={{.SizeMB}}
{{else if eq .MountPoint "/boot"}}
part /boot --fstype={{.FileSystem}} --size={{.SizeMB}}
{{else if eq .MountPoint "/boot/efi"}}
part /boot/efi --fstype={{.FileSystem}} --size={{.SizeMB}} --fsoptions="umask=0077,shortname=winnt"
{{else}}
part {{.MountPoint}} --fstype={{.FileSystem}} --size={{.SizeMB}}{{if .Grow}} --grow{{end}}
{{end}}
{{end}}
{{else}}
# Default partitioning scheme
part /boot --fstype=ext4 --size=1024
part swap --fstype=swap --size=8192
part / --fstype=ext4 --size=1 --grow
{{end}}

# Network information
{{if .Profile.Config.NetworkConfig}}
{{with .Profile.Config.NetworkConfig}}
network --bootproto={{.BootProto}} \
{{if eq .BootProto "static"}}
  --ip={{.IPAddress}} \
  --netmask={{.Netmask}} \
  --gateway={{.Gateway}} \
  --nameserver={{.DNS}} \
{{end}}
  --device={{.Device}} \
  --hostname={{$.Machine.Hostname}} \
  --onboot=yes \
  --activate
{{end}}
{{else}}
# Default: DHCP
network --bootproto=dhcp --device=eth0 --onboot=yes --activate --hostname={{.Machine.Hostname}}
{{end}}

# Reboot after installation
reboot

# Package selection
%packages
@core
@base
wget
curl
vim
net-tools
bind-utils
ntp
chrony
cloud-init
python3
{{if .Profile.Config.Packages}}
{{range .Profile.Config.Packages}}
{{.}}
{{end}}
{{end}}
%end

# Pre-installation script
%pre --log=/tmp/ks-pre.log
#!/bin/bash

echo "=========================================="
echo "CloudBoot NG - Pre-Installation Script"
echo "=========================================="
echo "Machine ID: {{.Machine.ID}}"
echo "MAC Address: {{.Machine.MacAddress}}"
echo "Hostname: {{.Machine.Hostname}}"
echo "=========================================="

# Report installation start to CloudBoot Core
curl -X POST {{.ServerURL}}/api/boot/v1/status \
  -H "Content-Type: application/json" \
  -d '{
    "machine_id": "{{.Machine.ID}}",
    "status": "installing",
    "step": "pre_install"
  }' || true

%end

# Post-installation script
%post --log=/root/ks-post.log
#!/bin/bash

echo "=========================================="
echo "CloudBoot NG - Post-Installation Script"
echo "=========================================="

# Disable SELinux
sed -i 's/^SELINUX=.*/SELINUX=disabled/g' /etc/selinux/config

# Configure NTP
systemctl enable chronyd
systemctl start chronyd

# Configure SSH
sed -i 's/#PermitRootLogin.*/PermitRootLogin yes/g' /etc/ssh/sshd_config
systemctl enable sshd
systemctl start sshd

# Install CloudBoot Agent (optional)
{{if .Profile.Config.InstallAgent}}
echo "Installing CloudBoot Agent..."
curl -o /tmp/cloudboot-agent {{.ServerURL}}/static/bin/cloudboot-agent
chmod +x /tmp/cloudboot-agent
mv /tmp/cloudboot-agent /usr/local/bin/cloudboot-agent

# Create systemd service
cat > /etc/systemd/system/cloudboot-agent.service <<'AGENT_SERVICE'
[Unit]
Description=CloudBoot Agent
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/cloudboot-agent --server={{.ServerURL}} --mac={{.Machine.MacAddress}}
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
AGENT_SERVICE

systemctl enable cloudboot-agent
systemctl start cloudboot-agent
{{end}}

# Custom post-install scripts
{{if .Profile.Config.PostScript}}
{{.Profile.Config.PostScript}}
{{end}}

# Report installation completion to CloudBoot Core
curl -X POST {{.ServerURL}}/api/boot/v1/status \
  -H "Content-Type: application/json" \
  -d '{
    "machine_id": "{{.Machine.ID}}",
    "status": "success",
    "step": "post_install"
  }' || true

echo "=========================================="
echo "Installation completed successfully!"
echo "=========================================="

%end
