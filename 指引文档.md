Elite Dev Team 已激活。我们将基于您提供的 CloudBoot NG 全套战略、架构及实施文档，启动文档驱动开发流水线。

以下是各角色依次产出的核心指导文档。

---

### 阶段 1：需求定义
**角色**：产品经理 (Product Manager)
**产出**：`docs/requirements/PRD.md`

--- START OF FILE docs/requirements/PRD.md ---

---
status: Approved
author: 产品经理
reviewers: [CEO, 架构师]
created: 2026-01-15
updated: 2026-01-15
version: 1.0
---

# 产品需求文档 (PRD) - CloudBoot NG

## 1. 文档信息
| 项目 | 内容 |
|------|------|
| 项目名称 | CloudBoot NG (Phoenix) |
| 核心Slogan | 以代码重构基础设施秩序 |
| 密级 | 核心机密 |

## 2. 项目概述
### 2.1 背景
信创硬件碎片化（华为、海光、飞腾等）与 AI 算力爆发导致基础设施运维复杂度（熵）急剧增加。传统的“人肉运维”（云新模式）成本高、黑盒化、不可审计。

### 2.2 目标
构建全栈物理机生命周期管理体系，实现：
1.  **物理机的 Terraform**：提供标准化、可编程的 IaC 接口。
2.  **数字签证官**：对异构硬件进行准入体检与合规清洗。
3.  **商业闭环**：通过免费工具（PE/Core）占领市场，通过认证（To V）和订阅（To B）变现。

### 2.3 成功指标 (KPI)
*   **部署效率**：单节点上线时间 < 10分钟（含 RAID/BIOS 配置）。
*   **交付形态**：CloudBoot Core 单体二进制体积 < 60MB；BootOS 启动时间 < 15秒。
*   **兼容性**：覆盖主流信创芯片（鲲鹏、海光、飞腾）。

## 3. 用户画像
| 画像名称 | 特征 | 痛点 | 需求 |
|----------|------|------|------|
| **Ops (老王)** | 一线运维，负责上架救火 | 手工配置 RAID 易出错，异构硬件工具繁杂 | 傻瓜化工具 (PE)，自动化装机，可视化进度 |
| **Dev (极客)** | 运维开发，写脚本 | 厂商接口不统一，脚本维护困难 | 标准 API，能够复用旧脚本，自定义驱动 |
| **Manager** | 部门经理，背合规指标 | 供应链黑盒风险，审计困难 | 资产准入签证，操作审计，离线部署 |

## 4. 功能需求

### 4.1 核心平台 (CloudBoot Core)
| ID | 功能名称 | 优先级 | 描述 | 验收标准 |
|----|----------|--------|------|----------|
| F001 | **单体部署** | P0 | 零依赖 Go 二进制，内置 SQLite/Web | `chmod +x` 后运行，10秒内 Web 可访问 |
| F002 | **资产纳管** | P0 | PXE 自动发现，硬件指纹采集与比对 | 能识别 CPU/内存/RAID 变更并告警 |
| F003 | **任务编排** | P0 | RAID->BIOS->OS 流水线，支持断点续传 | 任务失败后修复可重试，不丢失前序状态 |
| F004 | **OS Designer** | P1 | 可视化分区编辑器，实时生成 Kickstart | 拖拽分区，右侧代码实时更新 |
| F005 | **实时日志** | P1 | SSE 推送，黑客帝国风格滚动日志 | 界面无刷新，日志逐行显示 |

### 4.2 驱动生态 (CSPM & Store)
| ID | 功能名称 | 优先级 | 描述 | 验收标准 |
|----|----------|--------|------|----------|
| F006 | **Private Store** | P0 | 离线导入 .cbp 包，水印/签名校验 | 非法签名的包拒绝导入，非授权包红条警告 |
| F007 | **动态 DRM** | P0 | 内存解密运行，重启即焚 | 磁盘上无明文 Provider，传输过程加密 |
| F008 | **User Overlay** | P2 | 用户微调配置覆盖默认逻辑 | 修改 Overlay 参数后，Provider 行为改变 |

### 4.3 执行底座 (BootOS)
| ID | 功能名称 | 优先级 | 描述 | 验收标准 |
|----|----------|--------|------|----------|
| F009 | **无状态运行** | P0 | 全内存运行 (Tmpfs)，ZRAM 内存压缩 | 关机后不留任何数据，低配机器不 OOM |
| F010 | **双模引导** | P0 | 支持 Legacy BIOS 和 UEFI Secure Boot | 同一 ISO 支持两种启动方式 |

## 5. 非功能需求
*   **安全性**：Provider 必须在沙箱中运行，严禁写入除 `/opt/cloudboot/runtime` 外的路径。
*   **性能**：支持并发 500+ 节点同时部署。
*   **界面**：深色工业风 (Dark Industrial)，JetBrains Mono 字体，体现专业感。

---
--- END OF FILE docs/requirements/PRD.md ---

---

### 阶段 2：系统架构
**角色**：系统架构师 (System Architect)
**产出**：`docs/design/ARCHITECTURE.md`

--- START OF FILE docs/design/ARCHITECTURE.md ---

---
status: Approved
author: 架构师
reviewers: [技术负责人]
created: 2026-01-16
updated: 2026-01-16
version: 1.0
depends_on: [PRD.md]
---

# 架构设计文档 - CloudBoot NG

## 1. 架构概述
本架构旨在实现**“单体交付、无状态运行、软硬解耦”**。系统分为控制面 (Core) 和数据面 (BootOS)，通过 CSPM 协议交互。

## 2. 技术栈选型 (GOTH Stack)
为了满足银行级离线部署和极致轻量化需求，严禁引入 Node.js/Java/Python 运行时。
*   **Language**: Go 1.22+ (Static Binary)
*   **Web**: Echo v4 + HTMX (SSR + 局部刷新) + Alpine.js (微交互)
*   **Database**: SQLite3 (WAL Mode) / Gorm
*   **Style**: Tailwind CSS (Embedded)
*   **OS Base**: OpenEuler 22.03 (BootOS)

## 3. 系统架构 (C4 Model)

### 3.1 容器图 (Container Diagram)
```
┌─────────────────────────────────────────────────────────────┐
│                    CloudBoot Core (Server)                   │
│  [Go Single Binary]                                         │
│                                                             │
│  ┌─────────┐   ┌─────────────┐   ┌───────────────────────┐  │
│  │ Web UI  │◀──┤ HTMX/SSE    │   │     Private Store     │  │
│  │ (Embed) │   │ API Handler │   │ (DRM/Watermark Check) │  │
│  └─────────┘   └──────┬──────┘   └──────────┬────────────┘  │
│                       │                     │               │
│                ┌──────▼──────┐              │               │
│                │ Orchestrator│              │ .cbp Files    │
│                │ (StateMachine)             │ (Encrypted)   │
│                └──────┬──────┘              │               │
└───────────────────────┼─────────────────────┼───────────────┘
                        │ HTTP/WebSocket      │ HTTP Stream
                        │ (Cmd/Log)           │ (Provider+Key)
┌───────────────────────▼─────────────────────▼───────────────┐
│                    BootOS (Client)                          │
│  [RamDisk / Tmpfs]                                          │
│                                                             │
│  ┌─────────┐   ┌─────────────┐   ┌───────────────────────┐  │
│  │ cb-agent│──▶│  cb-fetch   │──▶│        cb-exec        │  │
│  │ (Brain) │   │  (Decrypter)│   │       (Sandbox)       │  │
│  └─────────┘   └─────────────┘   └──────────┬────────────┘  │
│                                             │ Stdin/Stdout  │
│                                     ┌───────▼───────┐       │
│                                     │   Provider    │       │
│                                     │   (Cartridge) │       │
│                                     └───────────────┘       │
└─────────────────────────────────────────────────────────────┘
```

## 4. 核心子系统设计

### 4.1 CSPM (CloudBoot Server Provider Mechanism)
*   **架构**：Host (Agent) -> Plugin (Provider) -> Chip (Adaptor)。
*   **协议**：JSON over Stdin/Stdout。
*   **安全**：
    1.  Core 使用 License 解密 Master Key。
    2.  Core 生成临时 Session Key 重加密 Provider。
    3.  BootOS 内存解密，执行后销毁。

### 4.2 任务编排与实时流
*   **状态机**：Pending -> Handshake -> Probing -> Provisioning -> Reporting。
*   **日志流**：Provider (Stderr JSON) -> cb-exec -> cb-agent -> Core (Broker) -> SSE -> Browser (Terminal View)。

### 4.3 动态资产库
*   **影子资产**：PXE 启动即注册，状态为 "Discovered"。
*   **指纹比对**：基于 `cb-probe` 返回的标准化 JSON，每次任务前比对 CPU/内存/RAID 摘要，防止硬件篡改。

## 5. 数据架构

### 5.1 核心实体 (ER)
*   **Machine**: 物理机资产，包含 `HardwareSpec` (JSONB)。
*   **Job**: 任务流水线，记录 `StepCurrent` 和 `LogsPath`。
*   **OSProfile**: 安装模板，包含分区 (`[]Partition`) 和网络配置。
*   **License**: 离线授权，包含 `ProductKey` (用于解密 Provider)。

## 6. 部署架构
*   **Server**: 单机部署，`./cloudboot-core`，数据存 `data.db`。
*   **Network**: 需开启 DHCP/TFTP 端口 (67/69) 及 HTTP (80/443)。
*   **BootOS**: 通过 PXE 加载至内存，无本地持久化。

---
--- END OF FILE docs/design/ARCHITECTURE.md ---

---

### 阶段 3：接口规范
**角色**：架构师 (System Architect)
**产出**：`docs/api/API-SPEC.yaml`

--- START OF FILE docs/api/API-SPEC.yaml ---

openapi: 3.0.3
info:
  title: CloudBoot Core API
  description: 包含 Agent 通信接口 (Boot API) 和 外部集成接口 (External API)
  version: 1.0.0

tags:
  - name: Boot
    description: BootOS Agent 专用接口
  - name: Machine
    description: 物理机管理 (Terraform 友好)
  - name: Stream
    description: 实时日志流

paths:
  # --- Boot API (Agent -> Server) ---
  /api/boot/v1/register:
    post:
      tags: [Boot]
      summary: Agent 上线注册/心跳
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                mac:
                  type: string
                ip:
                  type: string
                fingerprint:
                  $ref: '#/components/schemas/HardwareFingerprint'
      responses:
        '200':
          description: 注册成功，返回握手指令

  /api/boot/v1/task:
    get:
      tags: [Boot]
      summary: Agent 轮询任务
      parameters:
        - name: mac
          in: query
          required: true
          schema: { type: string }
      responses:
        '200':
          description: 返回任务指令 (CSPM JSON)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskSpec'

  # --- External API (Terraform/UI) ---
  /api/v1/servers:
    get:
      tags: [Machine]
      summary: 获取机器列表
      responses:
        '200':
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Machine' }
    post:
      tags: [Machine]
      summary: 纳管/创建机器
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Machine' }

  /api/v1/servers/{id}/provision:
    post:
      tags: [Machine]
      summary: 触发装机任务
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                profile_id: { type: string }
      responses:
        '202':
          description: 任务已接受
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Job' }

  # --- SSE Stream ---
  /api/stream/logs/{job_id}:
    get:
      tags: [Stream]
      summary: 实时日志流 (SSE)
      parameters:
        - name: job_id
          in: path
          required: true
          schema: { type: string }
      responses:
        '200':
          description: text/event-stream 流
          content:
            text/event-stream:
              schema:
                type: string
                example: |
                  data: <div class="text-emerald-500">[RAID] Config Success</div>

components:
  schemas:
    Machine:
      type: object
      properties:
        id: { type: string }
        hostname: { type: string }
        mac: { type: string }
        status: { type: string, enum: [discovered, ready, installing, active] }
        hardware: { $ref: '#/components/schemas/HardwareFingerprint' }

    HardwareFingerprint:
      type: object
      properties:
        cpu:
          type: object
          properties:
            model: { type: string }
            cores: { type: integer }
        memory:
          type: object
          properties:
            total_bytes: { type: integer }
        storage_controllers:
          type: array
          items:
            type: object
            properties:
              vendor: { type: string }
              model: { type: string }

    TaskSpec:
      type: object
      properties:
        task_id: { type: string }
        action: { type: string, enum: [probe, apply] }
        provider_url: { type: string }
        session_key: { type: string } # Encrypted Session Key
        config: { type: object } # CSPM Spec

    Job:
      type: object
      properties:
        id: { type: string }
        status: { type: string }
        step_current: { type: string }
---
--- END OF FILE docs/api/API-SPEC.yaml ---

---

### 阶段 4：任务分解
**角色**：技术负责人 (Tech Lead)
**产出**：`docs/dev/TASK-BREAKDOWN.md`

--- START OF FILE docs/dev/TASK-BREAKDOWN.md ---

---
status: Approved
author: 技术负责人
reviewers: [开发团队]
created: 2026-01-16
updated: 2026-01-16
version: 1.0
depends_on: [PRD.md, ARCHITECTURE.md]
---

# 任务分解文档 - CloudBoot NG "Velocity"

## 1. 任务总览
基于“作战地图”，我们将开发周期拆分为 6 个特种行动。
**总策略**：交互开发（视觉/体验）与 挂机开发（逻辑/底层）交替进行。

## 2. 详细任务分解

### 2.1 行动 1：创世纪 (Genesis) - 骨架与视觉
| ID | 任务 | 负责人 | 估时 | 依赖 |
|----|------|--------|------|------|
| G-01 | **项目基建**：Go mod, Makefile, Tailwind CLI 配置 | 全栈 | 0.5d | - |
| G-02 | **UI 组件库**：实现 Card, Button, Badge, Terminal (HTML/Tailwind) | 全栈 | 0.5d | G-01 |
| G-03 | **布局实现**：Sidebar, Topbar, 响应式框架 | 全栈 | 0.5d | G-02 |
| G-04 | **Design System 页**：`/design-system` 路由及展示页 | 全栈 | 0.2d | G-03 |

### 2.2 行动 2：核心脏器 (Core Organs) - 后端逻辑
| ID | 任务 | 负责人 | 估时 | 依赖 |
|----|------|--------|------|------|
| C-01 | **数据层**：Gorm Models (Machine, Job, License), SQLite WAL | 后端 | 0.5d | G-01 |
| C-02 | **CSPM 引擎**：PluginManager, Executor (Stdin/Stdout 交互) | 后端 | 1.0d | C-01 |
| C-03 | **Mock Provider**：编写模拟 RAID 配置的 Go 二进制 | 后端 | 0.5d | C-02 |
| C-04 | **单元测试**：Core 逻辑与 Mock Provider 的集成测试 | 后端 | 0.5d | C-03 |

### 2.3 行动 3：杀手级体验 (Killer Exp) - 前端交互
| ID | 任务 | 负责人 | 估时 | 依赖 |
|----|------|--------|------|------|
| K-01 | **SSE 管道**：LogBroker 实现, HTMX SSE 扩展集成 | 全栈 | 0.5d | C-02 |
| K-02 | **OS Designer**：Alpine.js 实现分区拖拽与状态管理 | 全栈 | 1.0d | G-02 |
| K-03 | **实时预览**：后端 Template 渲染接口 + 前端 hx-post | 全栈 | 0.5d | K-02 |
| K-04 | **联调 Demo**：点击测试 -> 终端弹窗 -> 日志滚动 | 全栈 | 0.5d | K-01, C-03 |

### 2.4 行动 4：配置生成引擎 (Compiler)
| ID | 任务 | 负责人 | 估时 | 依赖 |
|----|------|--------|------|------|
| CP-01| **模板库**：CentOS 7/8, Ubuntu, SUSE 模板编写 (`.tmpl`) | 后端 | 0.5d | - |
| CP-02| **渲染引擎**：ConfigGen 接口, Helper Functions | 后端 | 0.5d | CP-01 |
| CP-03| **校验器**：分区/网络逻辑校验 | 后端 | 0.5d | CP-02 |
| CP-04| **Table-Driven 测试**：20+ 用例覆盖边缘场景 | 后端 | 0.5d | CP-03 |

### 2.5 行动 5：数据面 (Data Plane) - BootOS
| ID | 任务 | 负责人 | 估时 | 依赖 |
|----|------|--------|------|------|
| D-01 | **cb-agent**：HTTP 客户端, 任务轮询, 下载器 (静态编译) | 系统 | 1.0d | C-02 |
| D-02 | **cb-probe/exec**：硬件探测与沙箱执行逻辑 | 系统 | 1.0d | D-01 |
| D-03 | **构建工厂**：Dockerfile, `dracut` 生成 initrd, ISO 打包 | DevOps | 1.0d | D-02 |
| D-04 | **hw-init**：TUI 工具封装 (Bubbletea) | 系统 | 0.5d | D-02 |

### 2.6 行动 6：全链路仿真 (Simulation)
| ID | 任务 | 负责人 | 估时 | 依赖 |
|----|------|--------|------|------|
| S-01 | **Seed Tool**：数据库预置 Mock Provider 数据 | 后端 | 0.2d | C-01 |
| S-02 | **QEMU 脚本**：`simulate.sh`, 网络配置 (User Net) | DevOps | 0.5d | D-03 |
| S-03 | **集成验收**：Web 下发 -> QEMU 执行 -> Web 日志回显 | Tech Lead | 0.5d | ALL |

## 3. 联调集成检查清单
*   [ ] Agent 能正确注册到 Core，并在界面显示 "Online"。
*   [ ] Mock Provider 的日志能通过 SSE 在 Web 端逐行显示。
*   [ ] OS Designer 生成的 Kickstart 文件能通过语法校验。
*   [ ] QEMU 环境下，Agent 下载 Provider 时自动解密成功。

---
--- END OF FILE docs/dev/TASK-BREAKDOWN.md ---

---

### 阶段 5：测试计划
**角色**：测试工程师 (QA Engineer)
**产出**：`docs/test/TEST-PLAN.md`

--- START OF FILE docs/test/TEST-PLAN.md ---

---
status: Approved
author: 测试工程师
reviewers: [产品经理, 技术负责人]
created: 2026-01-16
updated: 2026-01-16
version: 1.0
depends_on: [PRD.md, TASK-BREAKDOWN.md]
---

# 测试计划 - CloudBoot NG

## 1. 测试目标
确保 CloudBoot NG 在单体交付、离线环境下的核心功能闭环，重点验证 CSPM 协议的可靠性和 DRM 机制的安全性。

## 2. 测试范围

### 2.1 核心功能测试
| 功能模块 | 测试点 | 优先级 | 工具 |
|----------|--------|--------|------|
| **Core 平台** | 单体二进制启动、静态资源加载、SQLite WAL 并发 | P0 | 手工/Go Test |
| **CSPM 引擎** | Stdin/Stdout 协议解析、Stderr 日志流捕获 | P0 | Unit Test |
| **Private Store** | .cbp 包导入验签、水印识别、License 解密 | P0 | Unit Test |
| **OS Designer** | 分区配置生成准确性 (LVM/Bonding)、语法校验 | P1 | Table-Driven |

### 2.2 全链路仿真测试 (E2E)
使用 `scripts/simulate.sh` 和 QEMU 进行黑盒测试。

| 场景 ID | 场景描述 | 预期结果 |
|---------|----------|----------|
| **E2E-01** | **Agent 自动注册** | QEMU 启动后，Core 界面出现新机器，状态为 Discovered |
| **E2E-02** | **Mock RAID 任务** | 下发 Mock RAID 任务，界面弹出终端，日志实时滚动，最终变绿 |
| **E2E-03** | **DRM 解密** | 模拟非法 License，Agent 下载后解密失败，上报错误日志 |
| **E2E-04** | **断网重连** | QEMU 断网 1 分钟后恢复，Agent 自动重连，任务状态同步 |

### 2.3 安全测试 (Security)
*   **内存隔离**：验证 Provider 进程无法访问 `/opt/cloudboot/runtime` 以外的文件。
*   **数据销毁**：任务结束后，验证 Tmpfs 中的解密文件已被删除。
*   **Web 安全**：验证 HTMX 接口是否存在 XSS 漏洞，验证上传接口是否限制文件类型。

## 3. 测试环境
*   **Unit/Integration**: CI 环境 (GitHub Actions)，运行 `go test ./...`。
*   **Simulation**: 本地 macOS/Linux，安装 QEMU 和 Docker。
*   **Hardware (Optional)**: 实验室真实海光/鲲鹏服务器（如可用）。

## 4. 缺陷等级标准
*   **Critical**: 核心流程阻塞（如 Agent 无法连接、Provider 解密失败）。
*   **Major**: 功能缺陷但有规避方案（如 某些冷门 Linux 发行版模板渲染错误）。
*   **Minor**: UI 样式问题、非关键文案错误。

## 5. 准出标准
1.  所有 Unit Test 通过。
2.  E2E-01 至 E2E-03 场景在本地仿真环境验证通过。
3.  Core 二进制文件无外部依赖，在纯净 Linux VM 中可运行。
4.  不存在 Critical 和 Major 级遗留 Bug。

---
--- END OF FILE docs/test/TEST-PLAN.md ---

---

### 文档交接
**状态**：所有核心文档已生成 (Approved)。