è¿™æ˜¯ **è¡ŒåŠ¨ 4ï¼šé…ç½®ç”Ÿæˆå¼•æ“Ž (The Compiler)** çš„å…·ä½“ä»»åŠ¡æ‰§è¡Œè§„æ ¼ä¹¦ã€‚

è¯·å°†ä»¥ä¸‹å†…å®¹ä¿å­˜ä¸º `TASK_04_The_Compiler.md`ã€‚è¿™æ˜¯æ‚¨å‘ç»™ Claude Code çš„ç¬¬å››é“æˆ˜æœ¯æŒ‡ä»¤ã€‚ç”±äºŽè¿™æ˜¯çº¯æ–‡æœ¬é€»è¾‘å¤„ç†ï¼ŒAI çš„å‡†ç¡®çŽ‡æžé«˜ï¼Œéžå¸¸é€‚åˆ**å…¨è‡ªåŠ¨æŒ‚æœºæ¨¡å¼**ã€‚

---

# TASK_04_The_Compiler.md
**ä»»åŠ¡åç§°**ï¼šè¡ŒåŠ¨ 4ï¼šé…ç½®ç”Ÿæˆå¼•æ“Ž (æ¨¡æ¿é€»è¾‘ä¸Žæ ¡éªŒ)  
**æ‰§è¡Œæ¨¡å¼**ï¼šðŸŒ™ å…¨è‡ªåŠ¨æŒ‚æœº (Autonomous)  
**å‰ç½®ä¾èµ–**ï¼šå·²å®Œæˆ `TASK_02` (æ•°æ®æ¨¡åž‹å·²å®šä¹‰)ï¼Œéœ€è¯»å– `DATA_Schema.md` ä¸­çš„ `OSProfile` ç»“æž„ã€‚

---

## 1. ä»»åŠ¡ç›®æ ‡ (Objective)
æž„å»º Cloudboot NG çš„â€œç¿»è¯‘å®˜â€ã€‚å°†ç»“æž„åŒ–çš„ Go Struct (`OSProfile`) ç¼–è¯‘ä¸ºæ“ä½œç³»ç»Ÿå®‰è£…ç¨‹åºèƒ½è¯»æ‡‚çš„é…ç½®æ–‡ä»¶ï¼ˆKickstart, Autoyast, Preseed/Cloud-Initï¼‰ã€‚

**äº¤ä»˜ç‰©**ï¼š

1. **æ¨¡æ¿åº“**ï¼šè¦†ç›– CentOS 7/8/9, Ubuntu 20/22, SUSE 12/15, Kylin V10 çš„æ ‡å‡†æ¨¡æ¿æ–‡ä»¶ã€‚
2. **æ¸²æŸ“å¼•æ“Ž**ï¼š`internal/core/config_gen` åŒ…ï¼Œæä¾›ç»Ÿä¸€çš„ `Render` æŽ¥å£ã€‚
3. **æ ¡éªŒå™¨**ï¼šä¸šåŠ¡é€»è¾‘æ£€æŸ¥ï¼ˆå¦‚åˆ†åŒºåˆæ³•æ€§ã€ç½‘ç»œå‚æ•°å†²çªï¼‰ã€‚
4. **æµ‹è¯•å¥—ä»¶**ï¼šè‡³å°‘ 20 ä¸ª Table-Driven å•å…ƒæµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›–å„ç§è¾¹ç¼˜åœºæ™¯ã€‚

---

## 2. è¯¦ç»†æ‰§è¡Œæ­¥éª¤ (Execution Steps)
### Step 1: æ¨¡æ¿èµ„æºåŒ– (Template Assets)
+ **ä½ç½®**ï¼š`internal/core/config_gen/templates/`
+ **ä»»åŠ¡**ï¼šåˆ›å»ºä»¥ä¸‹ Go `text/template` æ–‡ä»¶ã€‚
    - `kickstart_el7.tmpl` (CentOS 7, Kylin V10)
    - `kickstart_el8.tmpl` (CentOS 8/9, AlmaLinux - æ³¨æ„ `authselect` vs `authconfig` çš„åŒºåˆ«)
    - `autoyast_sles.xml.tmpl` (SUSE)
    - `user_data.yaml.tmpl` (Ubuntu Autoinstall / Cloud-init)
+ **å…³é”®é€»è¾‘åµŒå…¥**ï¼š
    - **Storage**: ä½¿ç”¨ `{{ range .Partitions }}` å¾ªçŽ¯ç”Ÿæˆ `part`, `volgroup`, `logvol` æŒ‡ä»¤ã€‚
    - **Network**: æ”¯æŒé™æ€ IP å’Œ DHCP çš„æ¡ä»¶æ¸²æŸ“ã€‚
    - **Post-Script**: é¢„ç•™ `{{ .PostScript }}` æ’æ§½ï¼Œç”¨äºŽåŽç»­æ³¨å…¥ Agent å®‰è£…å‘½ä»¤ã€‚

### Step 2: æ¸²æŸ“å¼•æ“Žå®žçŽ° (The Rendering Engine)
+ **ä½ç½®**ï¼š`internal/core/config_gen/engine.go`
+ **æŽ¥å£å®šä¹‰**ï¼š

```go
func Render(profile models.OSProfile) ([]byte, error)
```

+ **é€»è¾‘**ï¼š
    1. **Distro è·¯ç”±**ï¼šæ ¹æ® `profile.Distro` (å¦‚ "centos7") é€‰æ‹©å¯¹åº”çš„ `.tmpl` æ–‡ä»¶ã€‚
    2. **Helper Functions**ï¼šæ³¨å†Œ Template FuncMapï¼Œä¾‹å¦‚ï¼š
        * `mbToGb`: å°† MB è½¬æ¢ä¸º GBï¼ˆæŸäº› OS éœ€è¦ï¼‰ã€‚
        * `cryptPwd`: å¦‚æžœä¼ å…¥æ˜¯æ˜Žæ–‡ï¼Œè°ƒç”¨åŠ å¯†åº“è½¬ä¸º SHA-512 Hashï¼›å¦‚æžœæ˜¯ Hash åˆ™ç›´æŽ¥ä½¿ç”¨ã€‚
    3. **æ‰§è¡Œæ¸²æŸ“**ï¼šå°†æ•°æ®å¡«å……è¿›æ¨¡æ¿ã€‚

### Step 3: ä¸šåŠ¡æ ¡éªŒå™¨ (The Validator)
+ **ä½ç½®**ï¼š`internal/core/config_gen/validator.go`
+ **ä»»åŠ¡**ï¼šåœ¨æ¸²æŸ“å‰ï¼Œå¯¹ `OSProfile` è¿›è¡Œé€»è¾‘æ£€æŸ¥ã€‚
+ **è§„åˆ™æ¸…å•**ï¼š
    - **é€šç”¨**ï¼šRoot å¯†ç ä¸èƒ½ä¸ºç©ºã€‚
    - **å­˜å‚¨**ï¼šå¿…é¡»åŒ…å«æŒ‚è½½ç‚¹ `/`ã€‚å¦‚æžœä½¿ç”¨äº† LVMï¼Œå¿…é¡»å®šä¹‰ VG Nameã€‚
    - **ç½‘ç»œ**ï¼šå¦‚æžœè®¾ä¸º Static IPï¼ŒNetmask å’Œ Gateway ä¸èƒ½ä¸ºç©ºã€‚
    - **SUSE ç‰¹æœ‰**ï¼šBtrfs åˆ†åŒºå»ºè®®å¼€å¯ Snapperã€‚

### Step 4: æš´åŠ›æµ‹è¯• (Massive Testing)
+ **ä½ç½®**ï¼š`internal/core/config_gen/engine_test.go`
+ **ç­–ç•¥**ï¼š**Table-Driven Tests**ã€‚
+ **ä»»åŠ¡**ï¼š
    - æž„é€ è‡³å°‘ 20 ç§ä¸åŒçš„ `OSProfile` ç»„åˆï¼ˆä¾‹å¦‚ï¼šå•ç½‘å¡ DHCPã€åŒç½‘å¡ Bond é™æ€ IPã€LVM åˆ†åŒºã€æ ‡å‡†åˆ†åŒºï¼‰ã€‚
    - è¿è¡Œæ¸²æŸ“ã€‚
    - **æ–­è¨€**ï¼šä¸æ£€æŸ¥ç”Ÿæˆçš„å…¨æ–‡ï¼ˆå¤ªè„†å¼±ï¼‰ï¼Œæ£€æŸ¥**å…³é”®ç‰¹å¾å­—ç¬¦ä¸²**ã€‚
        * ä¾‹å¦‚ï¼šå¦‚æžœ `LVM=true`ï¼Œæ£€æŸ¥è¾“å‡ºä¸­æ˜¯å¦åŒ…å« `volgroup`ã€‚
        * ä¾‹å¦‚ï¼šå¦‚æžœ `Distro=centos8`ï¼Œæ£€æŸ¥æ˜¯å¦åŒ…å« `authselect` ä¸”**ä¸åŒ…å«** `authconfig`ã€‚

---

## 3. éªŒæ”¶æ ‡å‡† (Acceptance Criteria)
å½“æ¬¡æ—¥æ¸…æ™¨æˆ‘ï¼ˆäººç±»æŒ‡æŒ¥å®˜ï¼‰æ£€æŸ¥ä»£ç æ—¶ï¼Œæ‰§è¡Œ `go test ./internal/core/config_gen/...` å¿…é¡»æ»¡è¶³ï¼š

1. **è¦†ç›–çŽ‡**ï¼šä»£ç è¦†ç›–çŽ‡ > 90%ã€‚
2. **å‡†ç¡®æ€§**ï¼šCentOS 7 å’Œ CentOS 8 çš„ç”Ÿæˆçš„ Kickstart æ–‡ä»¶å¿…é¡»ä½“çŽ°å‡ºè¯­æ³•å·®å¼‚ã€‚
3. **å®‰å…¨æ€§**ï¼šç”Ÿæˆçš„é…ç½®æ–‡ä»¶ä¸­ï¼Œå¯†ç å¿…é¡»æ˜¯åŠ å¯†åŽçš„ Hashï¼Œç»ä¸èƒ½å‡ºçŽ°æ˜Žæ–‡ã€‚

---

### **ç»™ Claude çš„å¯åŠ¨ Prompt**ï¼š
_(è¯·å¤åˆ¶ä»¥ä¸‹æŒ‡ä»¤ç»™ Claude)_

> "Claude, æˆ‘ä»¬è¿›å…¥ **è¡ŒåŠ¨ 4ï¼šé…ç½®ç”Ÿæˆå¼•æ“Ž**ã€‚  
è¿™æ˜¯ä¸€ä¸ª **å…¨è‡ªåŠ¨æŒ‚æœº (Autonomous)** ä»»åŠ¡ã€‚ä½ çš„ç›®æ ‡æ˜¯ç¼–å†™ä¸€ä¸ªå¥å£®çš„æ“ä½œç³»ç»Ÿé…ç½®æ–‡ä»¶ç”Ÿæˆå™¨ã€‚
>
> è¯·è¯»å– `TASK_04_The_Compiler.md` å’Œ `DATA_Schema.md`ã€‚
>
> **æ‰§è¡Œç­–ç•¥**ï¼š
>
> 1. **å…ˆå†™æµ‹è¯•**ï¼šåœ¨å†™å®žçŽ°ä¹‹å‰ï¼Œå…ˆåœ¨ `engine_test.go` ä¸­å®šä¹‰å¥½ 20 ä¸ªæµ‹è¯•ç”¨ä¾‹çš„æ•°æ®ç»“æž„ï¼ˆè¾“å…¥æ˜¯ä¸€ä¸ªå¤æ‚çš„ OSProfileï¼ŒæœŸæœ›è¾“å‡ºæ˜¯åŒ…å«æŸäº›å…³é”®å­—ï¼‰ã€‚
> 2. **ç¼–å†™æ¨¡æ¿**ï¼šåˆ›å»º `templates/` ç›®å½•ï¼Œç¼–å†™æ ‡å‡†çš„ Kickstart å’Œ Autoyast æ¨¡æ¿ã€‚æ³¨æ„å¤„ç† LVM çš„å¾ªçŽ¯é€»è¾‘ã€‚
> 3. **å®žçŽ°å¼•æ“Ž**ï¼šç¼–å†™ Go ä»£ç åŠ è½½æ¨¡æ¿å¹¶æ¸²æŸ“ã€‚
> 4. **å¾ªçŽ¯ä¿®å¤**ï¼šè¿è¡Œæµ‹è¯•ï¼Œå¦‚æžœç”Ÿæˆçš„é…ç½®ç¼ºå°‘å…³é”®å­—æˆ–é€»è¾‘é”™è¯¯ï¼Œä¿®æ­£æ¨¡æ¿æˆ– Go ä»£ç ï¼Œç›´åˆ°å…¨ç»¿ã€‚
>
> **ç‰¹åˆ«æ³¨æ„**ï¼š
>
> + ç¡®ä¿å¤„ç†å¥½ `text/template` çš„ç©ºç™½å­—ç¬¦ï¼ˆä½¿ç”¨ `{{-` è¯­æ³•ï¼‰ï¼Œè®©ç”Ÿæˆçš„é…ç½®æ–‡ä»¶æ•´æ´æ˜“è¯»ã€‚
> + ä¸è¦ç¡¬ç¼–ç æ¨¡æ¿è·¯å¾„ï¼Œä½¿ç”¨ `embed.FS` å°†æ¨¡æ¿æ‰“åŒ…è¿›äºŒè¿›åˆ¶ã€‚
>
> çŽ°åœ¨å¼€å§‹æ‰§è¡Œï¼Œç›´åˆ°æµ‹è¯•å…¨éƒ¨é€šè¿‡ã€‚"
>

