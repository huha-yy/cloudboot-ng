è¿™æ˜¯ **è¡ŒåŠ¨ 5ï¼šæ•°æ®é¢ (The Data Plane)** çš„å…·ä½“ä»»åŠ¡æ‰§è¡Œè§„æ ¼ä¹¦ã€‚

è¯·å°†ä»¥ä¸‹å†…å®¹ä¿å­˜ä¸º `TASK_05_The_Data_Plane.md`ã€‚è¿™æ˜¯æ‚¨å‘ç»™ Claude Code çš„ç¬¬äº”é“æˆ˜æœ¯æŒ‡ä»¤ã€‚ç”±äºŽæ¶‰åŠåˆ°ç³»ç»Ÿåº•å±‚æž„å»ºå’Œ Docker æ“ä½œï¼ŒAI çš„**è‡ªä¸»çº é”™èƒ½åŠ›**åœ¨è¿™é‡Œè‡³å…³é‡è¦ã€‚

---

# TASK_05_The_Data_Plane.md
**ä»»åŠ¡åç§°**ï¼šè¡ŒåŠ¨ 5ï¼šæ•°æ®é¢ (BootOS æž„å»ºä¸Ž Agent å¼€å‘)  
**æ‰§è¡Œæ¨¡å¼**ï¼šðŸŒ™ å…¨è‡ªåŠ¨æŒ‚æœº (Autonomous)  
**å‰ç½®ä¾èµ–**ï¼šå·²å®Œæˆ `TASK_02`ï¼Œéœ€è¯»å– `BootOS v4 æŠ€æœ¯ç™½çš®ä¹¦`ï¼ˆå¦‚æœ‰ï¼‰æˆ–å‚è€ƒ `ARCH_Stack.md` ä¸­çš„ç³»ç»Ÿçº¦æŸã€‚

---

## 1. ä»»åŠ¡ç›®æ ‡ (Objective)
æž„å»º Cloudboot NG çš„â€œèº¯å¹²â€ä¸Žâ€œæ‰‹è„šâ€ã€‚

1. **Agent**: å¼€å‘è¿è¡Œåœ¨å†…å­˜ä¸­çš„ Go å®ˆæŠ¤è¿›ç¨‹ï¼Œè´Ÿè´£ä¸Ž Server é€šä¿¡å¹¶æ‰§è¡Œä»»åŠ¡ã€‚
2. **OS Factory**: å»ºç«‹åŸºäºŽ Docker çš„è‡ªåŠ¨åŒ–æž„å»ºæµæ°´çº¿ï¼Œäº§å‡º BootOS çš„å†…æ ¸ä¸Ž Initrdã€‚
3. **hw-init**: å¤ç”¨ Agent é€»è¾‘ï¼Œæ‰“åŒ…å•æœºç‰ˆ TUI å·¥å…·ã€‚

**äº¤ä»˜ç‰©**ï¼š

1. `cmd/agent` æºç åŠé™æ€ç¼–è¯‘çš„äºŒè¿›åˆ¶ã€‚
2. `build/bootos/Dockerfile` åŠæž„å»ºè„šæœ¬ `build.sh`ã€‚
3. `cmd/hw-init` æºç åŠ TUI äº¤äº’é€»è¾‘ã€‚

---

## 2. è¯¦ç»†æ‰§è¡Œæ­¥éª¤ (Execution Steps)
### Step 1: Agent æ ¸å¿ƒé€»è¾‘ (The Agent)
+ **ä½ç½®**ï¼š`cmd/agent/` & `internal/agent/`
+ **æ ¸å¿ƒæ¨¡å—**ï¼š
    - **Handshake**: å¯åŠ¨æ—¶è¯»å– `/proc/cmdline` å¯»æ‰¾ `cb_server` å‚æ•°ã€‚å‘ Server å‘é€ `POST /api/boot/v1/register`ï¼ˆé™„å¸¦ç¡¬ä»¶æŒ‡çº¹ï¼‰ã€‚
    - **Poller**: ä¸€ä¸ªæ­»å¾ªçŽ¯ï¼Œæ¯ 3 ç§’è¯·æ±‚ `GET /api/boot/v1/task`ã€‚
    - **Executor**: å¤ç”¨ `internal/core/cspm` ä¸­çš„æ‰§è¡Œé€»è¾‘ï¼ˆæ³¨æ„ï¼šServer ç«¯æ˜¯è°ƒç”¨æœ¬åœ°æ’ä»¶ï¼ŒAgent ç«¯éœ€è¦å…ˆä¸‹è½½å†è°ƒç”¨ï¼‰ã€‚
    - **Streamer**: å®žçŽ°ä¸€ä¸ª `LogWriter`ï¼Œå°† `Write()` è°ƒç”¨è½¬æ¢ä¸º HTTP POST è¯·æ±‚ï¼ˆæˆ– WebSocket å¸§ï¼‰ï¼Œå‘é€ç»™ Serverã€‚
+ **æž„å»ºçº¦æŸ**ï¼šå¿…é¡»æ”¯æŒ **Static Build**ã€‚
    - åœ¨ Makefile ä¸­æ·»åŠ  `build-agent-linux`: `CGO_ENABLED=0 GOOS=linux go build -ldflags "-s -w"`ã€‚

### Step 2: å•æœºç¥žå™¨ (The Sidecar / hw-init)
+ **ä½ç½®**ï¼š`cmd/hw-init/`
+ **ä¾èµ–**ï¼šå¼•å…¥ `github.com/charmbracelet/bubbletea` (TUI æ¡†æž¶)ã€‚
+ **åŠŸèƒ½å®žçŽ°**ï¼š
    - **UI**: ä¸€ä¸ªé»‘åº•ç»¿å­—çš„ç»ˆç«¯ç•Œé¢ã€‚èœå•åŒ…æ‹¬ï¼š`[1] ç¡¬ä»¶ä½“æ£€`, `[2] RAIDé…ç½®`, `[3] å¯¼å‡ºæŒ‡çº¹`ã€‚
    - **é€»è¾‘å¤ç”¨**: ç›´æŽ¥è°ƒç”¨ Agent ä¸­çš„ `inspector` åŒ…èŽ·å–ç¡¬ä»¶ä¿¡æ¯ã€‚
    - **ç¦»çº¿æ¨¡å¼**: ä¸å°è¯•è¿žæŽ¥ Serverï¼Œè€Œæ˜¯è¯»å–æœ¬åœ° JSON é…ç½®æ–‡ä»¶ï¼ˆå¦‚æžœæœ‰ï¼‰ã€‚
    - **è¾“å‡º**: å°†æ‰«æç»“æžœç”Ÿæˆä¸º `report.html` (åµŒå…¥ç®€å•çš„ HTML æ¨¡æ¿) å¹¶å†™å…¥å½“å‰ç›®å½•ã€‚

### Step 3: BootOS æž„å»ºå·¥åŽ‚ (The OS Factory)
+ **ä½ç½®**ï¼š`build/bootos/`
+ **Dockerfile è®¾è®¡**:

```dockerfile
FROM openeuler/openeuler:22.03-lts
# å®‰è£…å†…æ ¸ä¸Žåº•å±‚å·¥å…·
RUN dnf install -y kernel systemd dracut iproute2 dhclient pciutils dmidecode openssh-server
# æ³¨å…¥ Agent (å‡è®¾æž„å»ºè„šæœ¬ä¼šå…ˆæŠŠ agent å¤åˆ¶åˆ°ä¸Šä¸‹æ–‡)
COPY cloudboot-agent /usr/local/bin/
# é…ç½® Systemd
COPY cloudboot.service /etc/systemd/system/
RUN systemctl enable cloudboot.service
```

+ **æž„å»ºè„šæœ¬ (**`build.sh`**)**:
    1. è°ƒç”¨ `make build-agent-linux`ã€‚
    2. `docker build -t cloudboot-builder .`
    3. `docker run --privileged -v $(pwd)/dist:/dist cloudboot-builder /bin/bash -c "dracut --force /dist/initrd.img $(uname -r) && cp /boot/vmlinuz* /dist/vmlinuz"`
    4. **äº§å‡º**: `dist/` ç›®å½•ä¸‹å‡ºçŽ° `vmlinuz` å’Œ `initrd.img`ã€‚

---

## 3. éªŒæ”¶æ ‡å‡† (Acceptance Criteria)
å½“æ¬¡æ—¥æ¸…æ™¨æ£€æŸ¥æ—¶ï¼Œå¿…é¡»æ»¡è¶³ï¼š

1. **ç¼–è¯‘é€šè¿‡**ï¼š`make build-agent-linux` å’Œ `make build-hw-init` æˆåŠŸç”ŸæˆäºŒè¿›åˆ¶æ–‡ä»¶ã€‚
2. **é™æ€æ£€æŸ¥**ï¼šè¿è¡Œ `file bin/cloudboot-agent`ï¼Œå¿…é¡»æ˜¾ç¤º `statically linked`ã€‚
3. **TUI éªŒè¯**ï¼šåœ¨æœ¬åœ°ç»ˆç«¯è¿è¡Œ `./bin/hw-init`ï¼Œèƒ½çœ‹åˆ° Bubbletea æ¸²æŸ“çš„æ¼‚äº®ç•Œé¢ï¼ˆè™½ç„¶åœ¨éž Linux çŽ¯å¢ƒä¸‹æ— æ³•æ‰«æçœŸå®žç¡¬ä»¶ï¼Œä½†ç•Œé¢é€»è¾‘åº”æ­£å¸¸ï¼‰ã€‚
4. **Docker æž„å»º**ï¼šå¦‚æžœæœ¬åœ°å®‰è£…äº† Dockerï¼Œè¿è¡Œ `build.sh` èƒ½å¤ŸæˆåŠŸåå‡º OS é•œåƒæ–‡ä»¶ã€‚

---

### **ç»™ Claude çš„å¯åŠ¨ Prompt**ï¼š
_(è¯·å¤åˆ¶ä»¥ä¸‹æŒ‡ä»¤ç»™ Claude)_

> "Claude, æˆ‘ä»¬è¿›å…¥ **è¡ŒåŠ¨ 5ï¼šæ•°æ®é¢å¼€å‘**ã€‚  
è¿™æ˜¯ä¸€ä¸ª **å…¨è‡ªåŠ¨æŒ‚æœº (Autonomous)** ä»»åŠ¡ï¼Œæ¶‰åŠç³»ç»Ÿç¼–ç¨‹å’Œ Docker æž„å»ºã€‚
>
> è¯·è¯»å– `TASK_05_The_Data_Plane.md`ã€‚
>
> **æ‰§è¡Œç­–ç•¥**ï¼š
>
> 1. **å…ˆåš Agent**ï¼šç¼–å†™ `cmd/agent`ã€‚å¤ç”¨ä¹‹å‰ CSPM çš„é€»è¾‘ï¼Œä½†é€‚é…ä¸º HTTP å®¢æˆ·ç«¯æ¨¡å¼ã€‚ç¡®ä¿ç¼–å†™äº† `_test.go` æ¥ Mock HTTP æœåŠ¡å™¨çš„å“åº”ã€‚
> 2. **å†åš hw-init**ï¼šä½¿ç”¨ `bubbletea` åº“å®žçŽ° TUIã€‚å¤ç”¨ Agent çš„æŽ¢é’ˆé€»è¾‘ã€‚
> 3. **æœ€åŽåš Dockerfile**ï¼šç¼–å†™ç”¨äºŽæž„å»º BootOS çš„ Dockerfile å’Œ Shell è„šæœ¬ã€‚
>
> **ç‰¹åˆ«æ³¨æ„**ï¼š
>
> + æ‰€æœ‰çš„ Go ç¼–è¯‘å¿…é¡»æ˜¯ **é™æ€é“¾æŽ¥ (Static Linked)**ï¼Œå› ä¸º BootOS çŽ¯å¢ƒéžå¸¸ç²¾ç®€ï¼Œæ²¡æœ‰ glibcã€‚
> + åœ¨ç¼–å†™ Agent æ—¶ï¼Œè¦å¤„ç†å¥½ç½‘ç»œæ–­è¿žé‡è¯•ï¼ˆRetry with Backoffï¼‰ã€‚
> + `hw-init` çš„ç•Œé¢è¦ç¬¦åˆæˆ‘ä»¬ 'Dark Industrial' çš„é£Žæ ¼ï¼ˆé»‘åº•ç»¿å­—ï¼‰ã€‚
>
> çŽ°åœ¨å¼€å§‹æ‰§è¡Œã€‚æ¯å®Œæˆä¸€ä¸ªç»„ä»¶ï¼Œè¿è¡Œç¼–è¯‘æ£€æŸ¥ã€‚"
>

