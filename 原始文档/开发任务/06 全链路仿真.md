这是 **行动 6：全链路仿真 (The Simulation)** 的具体任务执行规格书。

请将以下内容保存为 `TASK_06_The_Simulation.md`。这是您发给 Claude Code 的最后一道战术指令，也是我们验收成果、录制 Demo 视频的剧本。

---

# TASK_06_The_Simulation.md
**任务名称**：行动 6：全链路仿真 (黑客帝国环境构建)  
**执行模式**：⚡️ 交互开发 (Interactive)  
**前置依赖**：已完成 `TASK_05`，必须存在 `dist/vmlinuz` 和 `dist/initrd.img`。

---

## 1. 任务目标 (Objective)
构建一个**“本地微型数据中心”**。  
不需要真实的物理机，使用 QEMU 模拟一台裸金属服务器，让它连接到本地运行的 Cloudboot Server。验证从“发现”到“任务下发”再到“日志回传”的完整闭环。

**交付物**：

1. `scripts/simulate.sh`：一键启动环境的脚本。
2. **验证闭环**：Web 界面 -> 下发任务 -> QEMU 执行 -> Web 看到日志。

---

## 2. 详细执行步骤 (Execution Steps)
### Step 1: 编写仿真控制脚本 (The Matrix Script)
+ **位置**：`scripts/simulate.sh`
+ **逻辑**：
    1. **环境清理**：杀掉旧的 server 和 qemu 进程，清理 `/tmp/cloudboot-data`。
    2. **准备数据**：
        * 确保 `dist/` 下有内核和 initrd。
        * 将编译好的 `mock-provider` 复制到 Server 的文件服务目录，确保 Agent 能下载。
    3. **启动 Server**：
        * 运行 `./bin/cloudboot-server`。
        * 关键参数：`--public-url=http://10.0.2.2:8080` (这是 QEMU User Net 模式下访问宿主机的默认 IP)。
        * 等待 Server 端口 (8080) 就绪。
    4. **启动 QEMU (The Virtual Server)**：
        * 使用 `qemu-system-x86_64`。
        * **内存**：2048M。
        * **网络**：`-netdev user,id=n1 -device e1000,netdev=n1` (最简单的用户模式网络)。
        * **引导**：`-kernel dist/vmlinuz -initrd dist/initrd.img`。
        * **内核参数 (Cmdline)**：

```latex
console=ttyS0 
cb_server=http://10.0.2.2:8080 
cb_debug=true
```

        * **显示**：`-nographic` (日志直接输出到当前终端，方便调试) 或 `-vnc :0`。

### Step 2: 解决“鸡生蛋”问题 (Seed Data)
+ **问题**：Server 启动时是空的，Agent 上线后，如果没有任务可做，演示效果不佳。
+ **任务**：编写一个 `cmd/tools/seed_data.go`。
    - 在数据库中预置一个 `Provider` 记录：
        * Name: `provider-mock-raid`
        * URL: `http://10.0.2.2:8080/static/providers/mock-raid`
        * Checksum: (自动计算二进制文件的 Hash)
    - 在 `simulate.sh` 中，Server 启动后自动运行这个 seed 工具。

### Step 3: 联调与修补 (Debug Loop)
+ **交互模式**：
    - 运行脚本，观察 QEMU 输出。
    - **常见报错 A**：Agent 连不上 Server (Connection refused)。 -> 检查 `10.0.2.2` 是否正确，或者防火墙设置。
    - **常见报错 B**：Agent 下载 Provider 失败 (404)。 -> 检查 Server 的静态文件路由配置。
    - **常见报错 C**：Permission denied。 -> 检查 Provider 下载后是否赋予了 `+x` 权限。
+ **指令**：让 Claude 根据报错日志自动修改代码。

---

## 3. 验收剧本 (The Demo Script)
当开发完成后，按以下剧本进行验收（这也是发给投资人的 Demo 流程）：

1. **Action**: 终端运行 `./scripts/simulate.sh`。
    - **Expect**: 看到 Server 启动日志，紧接着看到 QEMU 的 Linux 启动滚屏。
2. **Action**: 观察 QEMU 日志。
    - **Expect**: 出现 `[Agent] Handshake success. Machine ID: xxxxx`。
3. **Action**: 打开浏览器 `http://localhost:8080`。
    - **Expect**: Dashboard 上“在线设备”显示 **1**。
4. **Action**: 进入设备详情页，点击 **"Run Mock RAID"** 按钮。
    - **Expect**:
        * 浏览器弹出黑色终端窗口。
        * QEMU 终端显示：`Executing provider...`
        * 浏览器的终端窗口开始同步滚动绿色日志：`[MOCK] Creating Virtual Drive...`
5. **Action**: 等待 3 秒。
    - **Expect**: 浏览器任务状态变为 ✅ Success。

---

### **给 Claude 的启动 Prompt**：
_(请复制以下指令给 Claude)_

> "Claude, 这是最后一战：**行动 6：全链路仿真**。  
你的目标是编写一个脚本，把之前开发的所有组件（Server, Agent, OS, Provider）串起来运行。
>
> 请读取 `TASK_06_The_Simulation.md`。
>
> **执行任务**：
>
> 1. **Seed Tool**: 编写 `cmd/tools/seed/main.go`，用于向数据库插入 Mock Provider 的元数据，并确保二进制文件在 Server 的下载目录中。
> 2. **Simulate Script**: 编写 `scripts/simulate.sh`。使用 `qemu-system-x86_64` 直接引导内核。注意处理好网络 IP (`10.0.2.2`)。
> 3. **Run & Fix**: 尝试运行脚本。如果 QEMU 里的 Agent 报错，请分析日志并修复 Agent 或 Server 的代码，直到流程跑通。
>
> **提示**：
>
> + 确保 Agent 在下载文件时，如果目录不存在会自动创建。
> + 确保 Server 启动时，静态文件服务已就绪。
>
> 现在开始构建 Matrix。"
>

