这是 **行动 3：杀手级体验 (The Killer Experience)** 的具体任务执行规格书。

请将以下内容保存为 `TASK_03_Killer_Experience.md`。这是您发给 Claude Code 的第三道战术指令，这一轮需要**交互模式**，因为涉及到复杂的 UI 逻辑和动画流畅度调整。

---

# TASK_03_Killer_Experience.md
**任务名称**：行动 3：杀手级体验 (实时流与配置设计器)  
**执行模式**：⚡️ 交互开发 (Interactive)  
**前置依赖**：已完成 `TASK_02`，且后端 CSPM 引擎已通过单元测试。

---

## 1. 任务目标 (Objective)
将冷冰冰的后端逻辑转化为**“看得见、摸得着”**的极致交互体验。  
核心攻克两个难点：

1. **The Matrix View**：基于 SSE 的实时日志流推送，让用户看到“黑客帝国”般的滚屏效果。
2. **OS Designer**：基于 Alpine.js 的动态分区编辑器，实现“左侧拖拽配置，右侧实时生成代码”。

**交付物**：

1. 支持 SSE 的 HTTP Handler。
2. 功能完备的 `OSProfile` 增删改查页面。
3. 一个能跑通“点击测试 -> 弹窗 -> 日志滚动 -> 成功变绿”的 Demo 闭环。

---

## 2. 详细执行步骤 (Execution Steps)
### Step 1: SSE 实时日志管道 (The Log Pipeline)
+ **后端实现** (`internal/api/stream.go`):
    - 实现一个 `LogBroker`，用于在 CSPM Executor 和 HTTP Response 之间转发消息。
    - 创建路由 `GET /api/stream/logs/:job_id`。
    - 设置 Headers: `Content-Type: text/event-stream`, `Cache-Control: no-cache`, `Connection: keep-alive`.
    - **逻辑**：当 CSPM 产生一条日志，Broker 将其格式化为 `data: <html-fragment>\n\n` 推送给前端。
    - **HTML 片段**：直接返回渲染好的 `<div>`，包含时间戳和带颜色的日志内容 (Info=White, Error=Red, Success=Green)。
+ **前端集成** (`web/templates/components/terminal.html`):
    - 引入 HTMX SSE 扩展 (`hx-ext="sse"`).
    - 在 Terminal 容器上绑定 `sse-connect="/api/stream/logs/..."`.
    - 在日志区域绑定 `sse-swap="message"` 和 `hx-swap="beforeend"`。
    - **自动滚动**：使用 Alpine.js (`x-init`) 监听 DOM 变化，每当有新日志加入，自动 Scroll 到底部。

### Step 2: OS Designer 前端交互 (The Visual Configurator)
+ **布局**：左右分栏。左侧 60% 表单，右侧 40% 代码预览（使用 `pre` 标签和 JetBrains Mono 字体）。
+ **状态管理 (Alpine.js)**:
    - 在父容器定义 `x-data="{ partitions: [], distro: 'centos7', ... }"`。
+ **分区编辑器组件**:
    - **列表渲染**：使用 `<template x-for>` 渲染当前分区列表。
    - **动态操作**：实现“添加分区”按钮（push 到数组）和“删除”按钮（splice 数组）。
    - **数据同步**：创建一个隐藏的 `<input type="hidden" name="partitions" :value="JSON.stringify(partitions)">`，以便 HTMX 提交表单时能带上数据。
+ **实时预览 (Live Preview)**:
    - 在表单容器上添加 `hx-post="/api/preview/kickstart"`。
    - 添加 `hx-trigger="change delay:300ms"` (防抖)。
    - 添加 `hx-target="#code-preview"`。
    - **后端逻辑**：接收表单数据，调用 `config_gen` 库渲染模板，返回纯文本。

### Step 3: 全链路联调 (The Demo Loop)
+ **入口**：在 Dashboard 或 Machine 列表页，为一个 Mock 机器添加“执行测试”按钮。
+ **动作**：
    - 点击按钮 -> `hx-post="/api/jobs/run_mock"`。
    - 后端创建一个 Job，启动 CSPM Mock Provider。
    - 前端跳转（或弹窗）到 Job 详情页。
    - Job 详情页自动连接 SSE，开始展示 Mock Provider 吐出的日志。
    - 当收到 `Status: Success` 事件时，UI 自动变绿，显示“完成”。

---

## 3. 验收标准 (Acceptance Criteria)
当开发完成后，我（人类指挥官）将进行以下操作，**必须**达到预期效果：

1. **日志流体验**：
    - 点击测试后，日志必须是**一行一行跳出来**的，而不是一下子全显示。
    - 终端窗口必须**自动滚动**到底部。
    - 颜色必须区分：普通日志是灰/白，关键节点（如 RAID Success）必须是**Emerald-500**。
2. **配置器体验**：
    - 在 OS Designer 里添加一个 `/data` 分区。
    - **0.3秒后**，右侧的代码预览区自动出现 `part /data --size=...`。
    - 整个过程页面**不能刷新**。
3. **视觉一致性**：
    - 所有输入框 Focus 时要有绿色的光环。
    - 所有字体符合 `UI_Design_System.md` 规范。

---

### **给 Claude 的启动 Prompt**：
_(请复制以下指令给 Claude)_

> "Claude, 我们进入 **行动 3：杀手级体验**。  
这是一个 **交互开发 (Interactive)** 任务，重点在于前端交互细节和 SSE 流式传输。
>
> 请读取 `TASK_03_Killer_Experience.md`，以及之前的 `UI_Design_System.md`。
>
> **执行顺序建议**：
>
> 1. **后端 SSE**：先在 `internal/api` 实现 LogBroker 和 SSE Handler。
> 2. **前端 Terminal**：修改 Terminal 组件支持 HTMX SSE 和 Alpine 自动滚动。
> 3. **联调日志流**：创建一个临时的测试页，验证点击按钮后能否看到 Mock 日志滚动。**（完成后请让我验收）**
> 4. **OS Designer**：实现分区编辑器的 Alpine.js 逻辑和实时预览接口。
>
> **关键约束**：
>
> + 必须使用 HTMX 的 SSE 扩展，不要手写 EventSource JS 代码。
> + 必须使用 Alpine.js 处理分区数据的增删改，不要依赖后端渲染编辑状态。
> + 确保 UI 风格严格遵循深色工业风。
>
> 现在开始 Step 1 & 2。"
>

