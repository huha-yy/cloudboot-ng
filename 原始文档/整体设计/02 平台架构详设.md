这是一份关于 CloudBoot NG 大脑中枢的详细架构设计文档。

它定义了**CloudBoot Core** 如何作为企业内网的指挥官，管理资产、编排任务、分发墨盒，并提供极致的用户体验。这份文档将指导研发团队构建一个**“单体交付、逻辑严密、体验惊艳”**的现代化平台。

---

# CloudBoot NG 全景产品设计白皮书
**第二卷：CloudBoot Core 平台架构详设 (The Brain)**

+ **项目代号**：Phoenix Core
+ **版本**：v1.0
+ **日期**：2026年1月
+ **密级**：核心机密 (Core Confidential)
+ **关联文档**：第一卷 (战略)，第三卷 (BootOS)

---

## 1. 架构总述：单体与现代化的融合
### 1.1 核心定义
**CloudBoot Core** 是部署在客户私有环境（企业内网/数据中心）的管控平台。它是整个体系的**大脑**。

+ **对下**：指挥 BootOS 进行物理操作。
+ **对上**：提供 API 给 Terraform 和蓝鲸。
+ **对内**：作为“私有商店”管理和分发加密的 Provider 墨盒。

### 1.2 物理架构：极致的“绿色软件”
为了适应银行严苛的部署环境（无外网、严禁安装依赖、审批流程长），我们采用 **Go Single Binary (单体二进制)** 架构。

+ **交付物**：一个约 50MB 的可执行文件 `cloudboot-core`。
+ **零依赖**：
    - **Web Server**：内置 Gin/Echo，不依赖 Nginx/Apache。
    - **Database**：内置 SQLite (WAL模式) 或支持外接 MySQL，不强制依赖外部 DB。
    - **Frontend**：HTML/CSS/JS 资源通过 `embed.FS` 编译进二进制，无静态文件目录。
    - **Services**：内置 TFTP、DHCP、HTTP、Syslog 服务。
+ **部署口号**：**“上传，chmod +x，运行。10秒内上线。”**

### 1.3 技术栈：GOTH 栈 (Go + HTMX)
我们放弃沉重的 React/Vue 前后端分离架构，回归 Web 本质，追求极致的开发效率和页面响应速度。

+ **后端渲染 (SSR)**：Go `html/template` (或 Templ)。
+ **动态交互**：**HTMX**。实现“点击按钮 -> 后端渲染 HTML 片段 -> 前端局部替换”的 SPA 级体验。
+ **微交互**：**Alpine.js**。处理 Dropdown、Modal、Tabs 等纯前端逻辑。
+ **样式**：**Tailwind CSS**。实现“深色工业风”视觉体系。

---

## 2. Private Store (私有商店)：核心枢纽设计
Private Store 是连接 CloudBoot.co (公网 SaaS) 和企业内网的**气闸 (Airgap)**，也是商业模式落地的关键。

### 2.1 逻辑架构：双向阀门
Private Store 必须解决**“如何把公网的墨盒安全地运进内网”**的问题。

+ **进货端 (Ingress)**：
    - **Mode A: 在线同步** (适合互联网客户)：配置官网 API Key，Core 自动拉取已购买的 Provider 元数据和二进制包。
    - **Mode B: 离线导入** (银行刚需)：管理员在官网下载 `.cbp` (CloudBoot Package) 或 `offline-bundle.zip`，通过浏览器上传到 Core。
+ **出货端 (Egress)**：
    - 面向 BootOS 的高性能文件服务。支持断点续传。
    - **动态 DRM**：文件在磁盘上是静态加密的。下载时，Core 根据 License 权限，动态生成 Session Key，将“墨盒 + 钥匙”一起发给 BootOS。

### 2.2 验钞机机制 (Verification Logic)
这是防止盗版和保障供应链安全的核心。导入 `.cbp` 包时，Core 执行以下检查：

1. **完整性验签**：验证包内的 `signature.sig` 是否由 CloudBoot 官方私钥签署。防止墨盒被篡改（植入后门）。
2. **水印审计**：读取包内的 `watermark.json`。
    - 如果水印归属（如“中国建设银行”）与当前 Core 的 License 归属（如“中国农业银行”）不一致。
    - **策略**：**不阻断**（保障业务连续性），但**记录高危审计日志**，并在界面显著位置显示红色警告条：**“非授权来源组件运行中”**。这借甲方之手打击了云新的违规操作。

---

## 3. 核心业务逻辑 (The Core Logic)
### 3.1 动态资产库 (Live Asset DB)
传统的 CMDB 是静态的“Excel 表格”，CloudBoot Core 的资产库是**活的**。

+ **影子资产 (Shadow Assets)**：
    - 当一台未录入的机器 PXE 启动 BootOS 时，它会自动向 Core 注册。
    - Core 将其标记为 **“发现 (Discovered)”** 状态，并在 Dashboard 上弹窗提示。
+ **指纹比对与防篡改**：
    - **基线快照**：机器第一次入库时，记录全量硬件指纹（CPU Stepping、内存条码、RAID卡固件）。
    - **每次装机前检查**：再次扫描指纹并比对。
    - **告警**：如果发现内存少了，或者网卡被换了，系统**拒绝装机**并触发“资产完整性告警”。

### 3.2 任务编排引擎 (The Orchestrator)
这是将“意图”转化为“行动”的调度中心。

+ **Pipeline 设计**：一个标准的装机任务被拆解为原子步骤序列：
    1. `WOL/IPMI Power On` (开机)
    2. `BootOS Handshake` (握手)
    3. `Inventory Check` (资产核验)
    4. `CSPM: RAID Config` (配置存储)
    5. `CSPM: BIOS Config` (配置固件)
    6. `OS Provisioning` (分发镜像)
    7. `Post-Install Scripts` (后置脚本)
+ **断点续传**：
    - 引擎记录每一步的 State。
    - 如果 RAID 配置成功但 OS 安装失败，管理员修复网络后点击“重试”，系统直接从 OS 安装步骤开始，**不会**重新破坏 RAID 数据。

---

## 4. OS Designer (配置设计器)：体验层核心
这是给“老王”用的杀手级工具，彻底终结手写 Kickstart 的痛苦。

### 4.1 数据模型
+ **Profile**：一个 JSON 结构体，描述了 OS 的所有配置（分区、网络、用户、包）。
+ **Template**：系统内置的“黄金模板”（CentOS 7/8, Ubuntu, SUSE, Kylin, UOS）。

### 4.2 可视化编辑器 (Visual Editor)
我们不提供文本框，我们提供**GUI 向导**。

+ **分区编辑器 (Partition Editor)**：
    - **交互**：一个横向的条形图代表硬盘。用户点击“+”增加分区，拖拽滑块调整大小。
    - **逻辑可视化**：如果选择了 LVM，界面上会出现嵌套框：`PV -> VG -> LV`。用户能直观看到逻辑卷是在卷组里面的。
    - **实时校验**：如果用户忘记创建 `/boot` 分区，或者 swap 设置得太小，界面直接红框报错。
+ **网络配置器**：
    - 图形化配置 Bond 模式（Mode 0/1/4）。自动生成复杂的 `ifcfg` 文件或 Netplan 配置。

### 4.3 实时编译 (Live Compiler)
+ **双栏视图**：左侧是表单，右侧是代码预览。
+ **动作**：当用户在左侧修改了时区，右侧 Kickstart 代码里的 `timezone Asia/Shanghai` 立即高亮闪烁并更新。
+ **后端**：Go Template 引擎负责将 JSON 渲染为 `ks.cfg` 或 `autoinst.xml`。

---

## 5. Web UI 与交互体验设计
### 5.1 视觉风格：Dark Console
+ **色调**：Slate-900 背景，Emerald-500 高亮。避免大面积白色刺眼，适合运维中心大屏展示。
+ **字体**：**JetBrains Mono** 用于所有 ID、IP、日志和代码。强化“工具属性”。

### 5.2 杀手级交互：The Matrix View (全息日志)
当用户点击正在安装的机器时，不会只看到一个进度条。

+ **界面**：弹出一个仿终端的黑色窗口。
+ **技术**：**SSE (Server-Sent Events)**。BootOS 发出的日志流，经过 Core 转发，实时推送到浏览器。
+ **内容**：
    - `[KERNEL] Linux version 5.10.0-60.18.0.50.oe2203...`
    - `[AGENT] Downloading provider-huawei-raid... 100%`
    - `[RAID] Creating Virtual Drive 0 (RAID 10)... Success`
+ **价值**：让过程**透明化**。老王可以看到机器在“思考”和“工作”，这比云新的黑盒进度条让人放心一万倍。

---

## 6. API 与扩展性设计
为了履行“物理机 Terraform”的承诺，Core 必须 API First。

### 6.1 Terraform 友好接口
+ **资源定义**：
    - `POST /api/v1/servers` (创建/纳管机器)
    - `POST /api/v1/servers/{id}/provision` (触发装机)
+ **状态查询**：
    - `GET /api/v1/servers/{id}` 返回包含详细硬件指纹的 JSON。
    - 这允许 Terraform 的 `data source` 读取物理机状态。

### 6.2 Legacy Bridge (老脚本兼容)
+ **Hook 机制**：
    - 在流水线的任意节点（如 Pre-Install, Post-Install），允许插入 `Shell` 或 `Python` 脚本。
    - **执行环境**：这些脚本会被下发到 BootOS 环境中执行。
+ **价值**：老用户不需要立刻重写所有逻辑，可以直接复用他们积累了十年的 `raid_config.sh`，平滑迁移。

---

## 7. 总结
CloudBoot Core 的设计，是在**“极简架构”**与**“极繁业务”**之间走钢丝。

+ 通过 **Go 单体** 和 **SQLite**，我们做到了部署的极简。
+ 通过 **CSPM** 和 **OS Designer**，我们做到了业务的深度覆盖。
+ 通过 **Private Store** 和 **审计机制**，我们做到了商业的闭环。

这就是那个能让老王**“敢用、想用、离不开”**的大脑中枢。

---

_(文档结束)_

